# 연차 계산 정책 변경사항

## 변경 일자: 2024-11-24

---

## 변경 사유
실제 회사 연차 정책에 맞춰 시스템 재구현
(근로기준법 기준 적용)

---

## 주요 변경사항

### 1. 월차 부여 방식

#### 이전
- **부여 시점:** 매월 1일 00:00 (고정)
- **부여 기간:** 입사 1년 미만
- **실행 주기:** 매월 1일 (Cron: `0 0 1 * *`)

#### 변경 후
- **부여 시점:** 입사일 기준 매월 같은 날짜
  - 예: 11/12 입사 → 매월 12일에 부여
  - 예: 09/01 입사 → 매월 1일에 부여
- **부여 기간:** 입사 1년 전날까지
  - 예: 2025-09-01 입사 → 2026-08-31까지
- **실행 주기:** 매일 00:00 (Cron: `0 0 * * *`)
  - 매일 체크하여 해당 직원만 부여

**변경된 파일:**
- `supabase/functions/grant-monthly-leave/index.ts` (완전 재작성)

---

### 2. 연차 부여 방식

#### 이전
- **부여 시점:** 입사 기념일 (매년 입사한 날짜)
  - 예: 2025-09-01 입사 → 2026-09-01, 2027-09-01...
- **부여 일수:** 15일 + 2년마다 1일 추가 (최대 25일)
  - 1~2년차: 15일
  - 3~4년차: 16일
  - 5~6년차: 17일
- **실행 주기:** 매일 00:00 (입사 기념일 체크)

#### 변경 후
- **부여 시점:** 회계연도 기준 매년 1월 1일
- **부여 일수:** 전년도 근속일수 비례 계산
  - **계산식:** `⌊(전년도 근속일수 ÷ 365) × 15일⌋`
  - **소수점 처리:** 0.5 미만 버림
- **예시:**
  - 2025-09-01 입사
  - 2026-01-01: (122일 ÷ 365) × 15 = 5.01 → **5일**
  - 2027-01-01: (365일 ÷ 365) × 15 = **15일**
  - 2028-01-01: (365일 ÷ 365) × 15 = **15일**
- **실행 주기:** 매년 1월 1일 00:00 (Cron: `0 0 1 1 *`)

**변경된 파일:**
- `supabase/functions/grant-anniversary-leave/` → **삭제**
- `supabase/functions/grant-annual-leave/index.ts` → **신규 생성**

---

### 3. 연차 소멸 시기

#### 이전
- **월차:** 부여일 기준 1년 후
- **연차:** 입사 기념일 기준 1년 후
  - 예: 2026-09-01 부여 → 2027-08-31 소멸

#### 변경 후
- **월차:** 입사 1년 되는 날 전날
  - 예: 2025-09-01 입사 → 2026-08-31 소멸
- **연차 (회계연도):** 당해 연도 12월 31일
  - 예: 2026-01-01 부여 → 2026-12-31 소멸
  - 예: 2027-01-01 부여 → 2027-12-31 소멸

---

## 파일 변경 내역

### 수정된 파일
1. **supabase/functions/grant-monthly-leave/index.ts**
   - 입사일 기준 부여 로직으로 완전 재작성
   - 매일 실행하여 해당 직원만 필터링

2. **supabase/migrations/20251124000003_setup_cron_jobs.sql**
   - 월차 Cron: `0 0 1 * *` → `0 0 * * *` (매일)
   - 연차 Cron: `0 0 * * *` → `0 0 1 1 *` (매년 1/1)

### 삭제된 파일
1. **supabase/functions/grant-anniversary-leave/**
   - 입사 기념일 기준 연차 부여 (구 방식)

### 신규 생성된 파일
1. **supabase/functions/grant-annual-leave/index.ts**
   - 회계연도 기준 비례 계산 연차 부여 (신규 방식)

---

## 테스트 결과 (박인사 케이스)

**입사일:** 2025-09-01
**시뮬레이션:** 3년 (36개월)

### 예상 결과
| 구분 | 월차 | 연차 | 총계 |
|------|------|------|------|
| 2025년 | 3일 | - | 3일 |
| 2026년 1/1 | - | 5일 (비례) | 5일 |
| 2026년 | 8일 | - | 8일 |
| 2027년 1/1 | - | 15일 | 15일 |
| 2028년 1/1 | - | 15일 | 15일 |
| **합계** | **11일** | **35일** | **46일** |

### 실제 결과
- 월차 합계: **11일** ✓
- 연차 합계: **35일** (5 + 15 + 15) ✓
- 최종 잔여: **46일** ✓

**검증 완료!**

---

## 배포 시 주의사항

### 1. Cron Job 재설정
기존 cron job 삭제 후 새로운 job 등록 필요:
```sql
-- 기존 job 삭제
SELECT cron.unschedule('grant-monthly-leave');
SELECT cron.unschedule('grant-anniversary-leave');

-- 새로운 job 등록 (migration 파일 재실행)
```

### 2. 데이터 마이그레이션
기존 연차 데이터의 만료일 재계산 필요:
- 월차: 입사 1년 되는 날 전날로 수정
- 연차: 회계연도 말 (12/31)로 수정

### 3. Production 환경 설정
`20251124000003_setup_cron_jobs.sql` 파일에서:
- URL: `http://127.0.0.1:54321` → `https://your-project.supabase.co`
- Bearer Token: 로컬 키 → 실제 `SUPABASE_SERVICE_ROLE_KEY`

---

## 참고 문서
- 근로기준법 제60조 (연차 유급휴가)
- 우정님 메시지 (2024-11-24)
